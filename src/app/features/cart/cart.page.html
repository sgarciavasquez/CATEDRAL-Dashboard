<app-header></app-header>

<div class="min-h-screen flex flex-col bg-[#f7f9fc]">
  <main class="flex-1 container-7xl py-6">
    <h1 class="text-2xl font-semibold text-[#2f3f56] mb-2">
      Carro de compras
    </h1>
    <p class="text-sm text-neutral-500 mb-6">
      Revisa tus productos antes de confirmar la reserva.
    </p>

    <ng-container *ngIf="(items$ | async) as items; else empty">
      <div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">

        <!-- LISTA -->
        <section class="bg-white rounded-2xl shadow-sm ring-1 ring-[#e8ecf4]">
          <div
            class="flex items-center gap-4 px-5 py-4 border-b last:border-b-0"
            *ngFor="let it of items"
          >
            <img
              [src]="it.product.imageUrl"
              class="w-16 h-16 rounded-lg object-contain bg-[#f5f7fb]"
              alt=""
            />

            <div class="flex-1 min-w-0">
              <div class="text-sm font-semibold text-[#2f3f56] truncate">
                {{ it.product.name }}
              </div>
              <div class="text-xs text-neutral-500">
                Precio unitario: {{ it.product.price | currency:'CLP':'symbol-narrow':'1.0-0' }}
              </div>
            </div>

            <!-- Cantidad -->
            <div class="flex items-center gap-2">
              <button
                type="button"
                class="w-8 h-8 rounded-full border border-slate-200 grid place-items-center text-sm hover:bg-slate-50"
                (click)="dec(it)"
              >
                −
              </button>
              <span class="w-8 text-center text-sm font-medium">
                {{ it.qty }}
              </span>
              <button
                type="button"
                class="w-8 h-8 rounded-full border border-slate-200 grid place-items-center text-sm hover:bg-slate-50"
                (click)="inc(it)"
              >
                +
              </button>
            </div>

            <!-- Quitar -->
            <button
              type="button"
              class="ml-3 inline-flex items-center gap-1 text-xs text-rose-600 hover:text-rose-700"
              (click)="remove(it)"
            >
              <mat-icon class="!text-[18px]">delete_outline</mat-icon>
              <span>Quitar</span>
            </button>
          </div>

          <div class="px-5 py-3 flex items-center justify-between text-xs text-neutral-500">
            <span>
              {{ items.length }} {{ items.length === 1 ? 'producto en el carro' : 'productos en el carro' }}
            </span>
            <button
              type="button"
              class="text-rose-600 hover:text-rose-700"
              (click)="clear()"
            >
              Vaciar carrito
            </button>
          </div>
        </section>

        <!-- RESUMEN -->
        <aside class="bg-white rounded-2xl shadow-sm ring-1 ring-[#e8ecf4] p-5 h-fit">
          <h2 class="text-base font-semibold text-[#2f3f56] mb-3">
            Resumen de tu pedido
          </h2>

          <div class="space-y-1 text-sm">
            <div class="flex justify-between">
              <span>Subtotal</span>
              <span>{{ total() | currency:'CLP':'symbol-narrow':'1.0-0' }}</span>
            </div>
            <div class="flex justify-between text-neutral-500">
              <span>Descuentos</span>
              <span>$0</span>
            </div>
          </div>

          <div class="border-t mt-3 pt-3 flex justify-between items-baseline">
            <span class="text-sm font-semibold text-[#2f3f56]">Total a pagar</span>
            <span class="text-lg font-bold text-[#2f3f56]">
              {{ total() | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </span>
          </div>

          <p class="mt-3 text-[11px] text-neutral-500 leading-snug">
            La reserva no tiene costo. El pago se coordina directamente con el vendedor.
          </p>

          <button
            mat-raised-button
            color="primary"
            class="w-full mt-4"
            (click)="reserve()"
            [disabled]="isSubmitting || !items.length"
          >
            <ng-container *ngIf="!isSubmitting; else loadingTpl">
              Confirmar reserva
            </ng-container>

            <ng-template #loadingTpl>
              <span class="inline-flex items-center gap-2 text-sm">
                <mat-progress-spinner
                  diameter="18"
                  mode="indeterminate">
                </mat-progress-spinner>
                <span>Procesando…</span>
              </span>
            </ng-template>
          </button>
        </aside>
      </div>
    </ng-container>

    <ng-template #empty>
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-[#e8ecf4] p-8 text-center">
        <p class="text-sm text-neutral-600">
          Tu carrito está vacío.
        </p>
      </div>
    </ng-template>
  </main>

  <app-footer class="mt-auto"></app-footer>
</div>
