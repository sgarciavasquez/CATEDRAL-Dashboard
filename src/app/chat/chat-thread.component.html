<app-header></app-header>

<div class="min-h-screen flex flex-col bg-[#f7f9fc]">
  <section class="w-full max-w-5xl mx-auto flex-1 px-3 py-4 sm:px-4 sm:py-6 flex flex-col gap-3">
    <!-- Encabezado + resumen -->
    <header class="rounded-xl bg-white p-3 sm:p-4 shadow-sm ring-1 ring-black/5">
      <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-slate-200 grid place-items-center">
            游낇
          </div>
          <div class="min-w-0">
            <h2 class="text-sm sm:text-base font-semibold text-slate-900">
              {{ otherName() }}
            </h2>
            <p class="text-[11px] sm:text-xs text-slate-500">
              {{
              chatClosed
              ? (isAdmin
              ? 'Chat cerrado para esta reserva. Solo visible como historial.'
              : 'Chat cerrado para esta reserva.')
              : 'Chat de la compra'
              }}
            </p>
          </div>
        </div>

        <a [routerLink]="[base]" class="text-xs sm:text-sm text-slate-600 hover:underline shrink-0">Volver</a>
      </div>

      <!-- Tarjeta de la reserva -->
      <div *ngIf="reservationPreview as rp" class="mt-3 rounded-lg border border-slate-100 bg-slate-50 p-3 space-y-2">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="text-sm font-medium text-slate-900 truncate">
              Reserva #{{ rp.reservationId }}
            </div>
            <div class="text-[11px] text-slate-500">
              Fecha: {{ rp.createdAt | date: 'short' }}
              <span *ngIf="rp.status" class="ml-1 uppercase">
                췅 Estado: {{ rp.status }}
              </span>
            </div>
          </div>
          <div class="text-sm font-semibold text-right whitespace-nowrap text-slate-900">
            Total: ${{ rp.total | number: '1.0-0' }}
          </div>
        </div>

        <div *ngIf="rp.items?.length" class="mt-1 max-h-24 overflow-y-auto space-y-1 pr-1">
          <div *ngFor="let it of rp.items" class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2 min-w-0">
              <img *ngIf="it.imageUrl" [src]="it.imageUrl" class="w-8 h-8 object-cover rounded" alt="" />
              <div class="truncate text-xs sm:text-sm text-slate-700">
                {{ it.name }}
                <span class="text-[11px] text-slate-500">
                  췅 {{ it.qty }} un.
                </span>
              </div>
            </div>
            <div class="text-xs sm:text-sm text-slate-900 font-medium shrink-0">
              ${{ it.price | number: '1.0-0' }}
            </div>
          </div>
        </div>

        <div class="pt-1 text-[11px] sm:text-[12px] text-slate-600">
          Coordina aqu칤 el punto de encuentro con el vendedor. Evita compartir
          datos sensibles.
        </div>
      </div>
    </header>

    <!-- Mensajes -->
    <div
      class="flex-1 rounded-xl bg-white p-3 sm:p-4 shadow-sm ring-1 ring-black/5 overflow-y-auto min-h-[45vh] max-h-[60vh] sm:max-h-[65vh]"
      (scroll)="onScroll($event)">
      <div *ngFor="let m of msgs()" class="mb-2 flex" [class.justify-end]="m.fromId === me().id">
        <div class="max-w-[78%] sm:max-w-[75%] rounded-2xl px-3 py-2 text-xs sm:text-sm"
          [class.bg-slate-900]="m.fromId === me().id" [class.text-white]="m.fromId === me().id"
          [class.bg-slate-100]="m.fromId !== me().id" [class.text-slate-900]="m.fromId !== me().id">
          <div class="whitespace-pre-wrap break-words">
            {{ m.text }}
          </div>
          <div class="mt-1 text-[10px] sm:text-[11px] opacity-70">
            {{ m.at | date: 'shortTime' }}
          </div>
        </div>
      </div>

      <div #endRef></div>
    </div>

    <!-- Composer (solo si el chat est치 abierto) -->
    <footer *ngIf="!chatClosed; else chatClosedMsg"
      class="mt-2 rounded-xl bg-white p-2 sm:p-3 shadow-sm ring-1 ring-black/5 flex items-center gap-2">
      <textarea [ngModel]="draft()" (ngModelChange)="draft.set($event)" (keydown.enter)="onEnter($event)" rows="1"
        placeholder="Escribe un mensaje"
        class="flex-1 resize-none rounded-lg border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-300">
      </textarea>

      <button (click)="send()" [disabled]="!draft().trim()"
        class="rounded-lg bg-slate-900 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-white disabled:opacity-40">
        Enviar
      </button>
    </footer>

    <ng-template #chatClosedMsg>
      <div class="mt-2 rounded-xl bg-slate-50 p-3 text-xs sm:text-sm text-slate-600 ring-1 ring-black/5">
        Esta reserva ya est치
        <strong>confirmada o cancelada</strong>, por lo que el chat est치
        cerrado. Si necesitas ayuda adicional, cont치ctanos por otro medio.
      </div>
    </ng-template>
  </section>

  <app-footer class="mt-auto"></app-footer>
</div>